{% extends 'base.html.twig' %}
{% block title %}Chantiers{% endblock %}

{% block body %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.7/css/dataTables.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.7/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.0.7/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.0.7/js/dataTables.bootstrap5.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 style="color: #232946; font-family: 'Segoe UI', sans-serif; font-weight: bold; letter-spacing: 1px;">Chantiers</h1>
        <button class="btn btn-primary" id="btnAddChantier" style="font-weight: 500;">Nouveau Chantier</button>
    </div>
    <div class="card shadow-sm p-4">
        <table id="chantierTable" class="table table-striped" style="width:100%">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Type</th>
                    <th>Adresse</th>
                    <th>Responsable</th>
                    <th>Tel Responsable</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for chantier in chantiers %}
                <tr>
                    <td>{{ chantier.nom }}</td>
                    <td>{{ chantier.type }}</td>
                    <td>{{ chantier.address }}</td>
                    <td>{{ chantier.responsable }}</td>
                    <td>{{ chantier.teleResponsable }}</td>
                    <td>
                        <button class="btn btn-sm btn-warning btnEdit" data-id="{{ chantier.id }}"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-danger btnDelete" data-id="{{ chantier.id }}"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Chantier (Ajout) -->
<div class="modal fade" id="chantierModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="chantierForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="chantierModalLabel">Ajouter un Chantier</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-4 mb-3">
          <div class="col-md-6">
            <label>Nom</label>
            <input type="text" name="nom" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label>Type</label>
            <input type="text" name="type" class="form-control" required>
          </div>
        </div>
        <div class="mb-3">
          <label>Description</label>
          <textarea name="description" class="form-control" rows="2" required></textarea>
        </div>
        <div class="row g-4 mb-3">
          <div class="col-md-6">
            <label>Date de début</label>
            <input type="date" name="date_debut" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label>Date de fin</label>
            <input type="date" name="date_fin" class="form-control" required>
          </div>
        </div>
        <div class="mb-3">
          <label>Utilisateurs affectés</label>
          <input name="users" id="usersTagify" class="form-control" placeholder="Sélectionner les utilisateurs..." required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Enregistrer</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
      </div>
    </form>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
<script>
let tagify;
let usersList = [];

// Load users for Tagify (AJAX)
function loadUsers() {
    return fetch('/api/users').then(r => r.json()).then(users => {
        usersList = users.map(u => ({
            value: u.id,
            name: u.nom + ' ' + u.prenom
        }));
        if (tagify) tagify.settings.whitelist = usersList;
    });
}

function showFlash(message, type='success') {
    Swal.fire({
        text: message,
        icon: type,
        timer: 2000,
        showConfirmButton: false,
        toast: true,
        position: 'top-end'
    });
}

$(document).ready(function() {
    $('#chantierTable').DataTable({
        language: {
            decimal: ",",
            thousands: " ",
            search: "Rechercher :",
            lengthMenu: "Afficher _MENU_ entrées",
            info: "Affichage de _START_ à _END_ sur _TOTAL_ entrées",
            infoEmpty: "Affichage de 0 à 0 sur 0 entrées",
            infoFiltered: "(filtré de _MAX_ entrées totales)",
            loadingRecords: "Chargement...",
            zeroRecords: "Aucun enregistrement correspondant trouvé",
            emptyTable: "Aucune donnée disponible dans le tableau",
            paginate: {
                first: '<i class="bi bi-chevron-bar-left"></i>',
                previous: '<i class="bi bi-chevron-left"></i>',
                next: '<i class="bi bi-chevron-right"></i>',
                last: '<i class="bi bi-chevron-bar-right"></i>'
            }
        }
    });
    // You can add modal open/edit/delete logic here as needed
    loadUsers().then(() => {
        let input = document.getElementById('usersTagify');
        tagify = new Tagify(input, {
            whitelist: usersList,
            enforceWhitelist: true,
            dropdown: { enabled: 0, maxItems: 20, closeOnSelect: false }
        });
    });
    document.getElementById('btnAddChantier').onclick = function() {
        document.getElementById('chantierForm').reset();
        tagify.removeAllTags();
        new bootstrap.Modal(document.getElementById('chantierModal')).show();
    };
    document.getElementById('chantierForm').onsubmit = function(e) {
        e.preventDefault();
        let formData = new FormData(this);
        let users = tagify.value.map(t => t.value);
        formData.set('users', users);
        fetch('/chantier/new', {
            method: 'POST',
            body: formData
        }).then(r => r.json()).then(res => {
            showFlash(res.message || 'Chantier ajouté', 'success');
            bootstrap.Modal.getInstance(document.getElementById('chantierModal')).hide();
            // TODO: Refresh table via AJAX (not implemented here)
        }).catch(() => showFlash('Erreur lors de l\'enregistrement', 'error'));
    };
});
</script>
{% endblock %}
