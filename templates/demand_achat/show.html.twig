{% extends 'base.html.twig' %}

{% block title %}Détails de la Demande d'Achat{% endblock %}

{% block stylesheets %}
<style>
    .status-badge {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
    }
    .details-table th {
        width: 30%;
    }
    .article-row {
        transition: all 0.2s;
    }
    .article-row:hover {
        background-color: #f8f9fa;
    }
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e3a8a;
        border-bottom: 2px solid #3b82f6;
        padding-bottom: 0.5rem;
        margin-bottom: 1.25rem;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid px-4 py-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Détails de la Demande d'Achat #{{ demande.id }}</h1>
        <div>
            <a href="{{ path('app_demand_achat') }}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left me-1"></i> Retour à la liste
            </a>
            <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Actions <i class="bi bi-chevron-down ms-1"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#"><i class="bi bi-pencil me-2"></i>Modifier</a></li>
                    <li><a class="dropdown-item" href="#"><i class="bi bi-printer me-2"></i>Imprimer</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteModal"><i class="bi bi-trash me-2"></i>Supprimer</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Informations générales -->
        <div class="col-md-5">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="card-title mb-0">Informations Générales</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="h6 mb-0">État:</span>
                        <span class="badge status-badge {% if demande.etat == 'En attente' %}bg-warning{% elseif demande.etat == 'Approuvée' %}bg-success{% elseif demande.etat == 'Rejetée' %}bg-danger{% else %}bg-secondary{% endif %}">
                            {{ demande.etat }}
                        </span>
                    </div>
                    
                    <table class="table details-table">
                        <tr>
                            <th>Numéro</th>
                            <td>{{ demande.id }}</td>
                        </tr>
                        <tr>
                            <th>Date</th>
                            <td>{{ demande.date|date('d/m/Y') }}</td>
                        </tr>
                        <tr>
                            <th>Utilisateur</th>
                            <td>{{ demande.uilisateur ? demande.uilisateur.nom ~ ' ' ~ demande.uilisateur.prenom : 'N/A' }}</td>
                        </tr>
                        <tr>
                            <th>Total HT</th>
                            <td>{{ demande.montantHT|number_format(2, ',', ' ') }} DH</td>
                        </tr>
                        <tr>
                            <th>TVA</th>
                            <td>{{ demande.tva }}%</td>
                        </tr>
                        <tr>
                            <th>Total TTC</th>
                            <td class="h5 text-primary">{{ demande.montantTTC|number_format(2, ',', ' ') }} DH</td>
                        </tr>
                    </table>
                    
                    <div class="mt-3">
                        <div class="section-title">Historique</div>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="fw-bold">Créée</span>
                                    <small class="d-block text-muted">par {{ demande.uilisateur ? demande.uilisateur.nom ~ ' ' ~ demande.uilisateur.prenom : 'N/A' }}</small>
                                </div>
                                <small class="text-muted">{{ demande.date|date('d/m/Y H:i') }}</small>
                            </li>
                            <!-- Ajoutez d'autres événements ici si nécessaire -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Articles de la demande -->
        <div class="col-md-7">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="card-title mb-0">Articles Demandés</h5>
                </div>
                <div class="card-body">
                    {% if demande.demandeDetails is empty %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Aucun article n'a été ajouté à cette demande.
                        </div>
                    {% else %}
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Article</th>
                                        <th>Fournisseur</th>
                                        <th>Quantité</th>
                                        <th>Prix Unitaire</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for detail in demande.demandeDetails %}
                                        <tr class="article-row">
                                            <td>
                                                {{ detail.article.nom }}
                                                <small class="d-block text-muted">{{ detail.article.reference }}</small>
                                            </td>
                                            <td>{{ detail.fournisseur }}</td>
                                            <td>{{ detail.quantite }}</td>
                                            <td>{{ detail.prixUnitaire|number_format(2, ',', ' ') }} DH</td>
                                            <td>{{ detail.prixTotal|number_format(2, ',', ' ') }} DH</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3"></td>
                                        <td class="fw-bold">Total HT</td>
                                        <td>{{ demande.montantHT|number_format(2, ',', ' ') }} DH</td>
                                    </tr>
                                    <tr>
                                        <td colspan="3"></td>
                                        <td class="fw-bold">TVA ({{ demande.tva }}%)</td>
                                        <td>{{ (demande.montantTTC - demande.montantHT)|number_format(2, ',', ' ') }} DH</td>
                                    </tr>
                                    <tr>
                                        <td colspan="3"></td>
                                        <td class="fw-bold">Total TTC</td>
                                        <td class="fw-bold">{{ demande.montantTTC|number_format(2, ',', ' ') }} DH</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Actions sur la demande -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="card-title mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            {% if demande.etat == 'En attente' %}
                                <button type="button" class="btn btn-success w-100 mb-3">
                                    <i class="bi bi-check-circle me-2"></i>Approuver la demande
                                </button>
                                <button type="button" class="btn btn-danger w-100">
                                    <i class="bi bi-x-circle me-2"></i>Rejeter la demande
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-outline-primary w-100">
                                    <i class="bi bi-arrow-repeat me-2"></i>Changer l'état
                                </button>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-secondary w-100 mb-3">
                                <i class="bi bi-printer me-2"></i>Imprimer la demande
                            </button>
                            <button type="button" class="btn btn-outline-success w-100">
                                <i class="bi bi-file-earmark-excel me-2"></i>Exporter en Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmation de suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer cette demande d'achat ? Cette action est irréversible.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Supprimer</button>
            </div>
        </div>
    </div>
</div>

{% block page_javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Logique de suppression
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    
    confirmDeleteBtn.addEventListener('click', function() {
        // Ici, vous ajouterez le code pour supprimer la demande via une requête AJAX
        alert('Fonctionnalité à implémenter: suppression de la demande.');
    });
});
</script>
{% endblock %}
{% endblock %}
