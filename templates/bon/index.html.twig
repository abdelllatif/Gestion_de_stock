{% extends 'base.html.twig' %}

{% block title %}Gestion des Bons{% endblock %}

{% block body %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.7/css/dataTables.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.7/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.0.7/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.0.7/js/dataTables.bootstrap5.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
    .badge-sortie {
        background-color: #ef4444;
        color: white;
    }
    
    .badge-entrée {
        background-color: #10b981;
        color: white;
    }
    
    .badge-transfert {
        background-color: #f59e0b;
        color: white;
    }
    
    .badge-article {
        background-color: #3b82f6;
        color: white;
    }
    
    .badge-machine {
        background-color: #8b5cf6;
        color: white;
    }
</style>
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 style="color: #232946; font-family: 'Segoe UI', sans-serif; font-weight: bold; letter-spacing: 1px;">Gestion des Bons</h1>
        <div>
            <a href="{{ path('article_movement') }}" class="btn btn-success me-2" style="font-weight: 500;">
                <i class="bi bi-arrow-left-right me-2"></i>Mouvement Stock
            </a>
            <a href="{{ path('app_bon_new') }}" class="btn btn-primary" style="font-weight: 500;">
                <i class="bi bi-plus-circle me-2"></i>Nouveau Bon
            </a>
        </div>
    </div>
    <div class="card shadow-sm p-4">
        <table id="bonsTable" class="table table-striped" style="width:100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Numéro</th>
                    <th>Type</th>
                    <th>Date</th>
                    <th>Chantier</th>
                    <th>Articles/Machines</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<script src="{{ asset('js/components/alert.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
    const table = $('#bonsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ path('app_bon') }}',
            type: 'GET',
            error: function(xhr, error, thrown) {
                let errorMessage = 'Une erreur est survenue lors du chargement des données.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage += ' Détails: ' + xhr.responseJSON.message;
                }
                console.error('Erreur DataTables:', error, thrown);
                showToast(errorMessage, 'danger');
                $('#bonsTable tbody').html('<tr><td colspan="7" class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle me-2"></i>' + errorMessage + '</td></tr>');
            }
        },
        columns: [
            { data: 'id', visible: false },
            { data: 'numeroSerie' },
            { 
                data: 'type', 
                render: function(data, type, row) {
                    if (type === 'display') {
                        let badgeClass = '';
                        let icon = '';
                        
                        if (data === 'Sortie') {
                            badgeClass = 'badge-sortie';
                            icon = '<i class="bi bi-box-arrow-right me-1"></i>';
                        } else if (data === 'Entrée') {
                            badgeClass = 'badge-entrée';
                            icon = '<i class="bi bi-box-arrow-in-right me-1"></i>';
                        } else {
                            badgeClass = 'badge-transfert';
                            icon = '<i class="bi bi-arrow-left-right me-1"></i>';
                        }
                        
                        return `<span class="badge ${badgeClass}">${icon}${data}</span>`;
                    }
                    return data;
                }
            },
            { data: 'date' },
            { data: 'chantier' },
            { 
                data: 'details',
                render: function(data, type, row) {
                    if (type === 'display') {
                        return `<span class="badge bg-secondary" data-bs-toggle="tooltip" title="Articles et machines inclus dans ce bon">${data} éléments</span>`;
                    }
                    return data;
                }
            },
            { 
                data: 'actions',
                orderable: false,
                searchable: false
            }
        ],
        order: [[3, 'desc']], 
        language: {
            decimal: ",",
            thousands: " ",
            search: "Rechercher :",
            lengthMenu: "Afficher _MENU_ entrées",
            info: "Affichage de _START_ à _END_ sur _TOTAL_ entrées",
            infoEmpty: "Affichage de 0 à 0 sur 0 entrées",
            infoFiltered: "(filtré de _MAX_ entrées totales)",
            loadingRecords: "Chargement...",
            zeroRecords: "Aucun enregistrement correspondant trouvé",
            emptyTable: "Aucune donnée disponible dans le tableau",
            paginate: {
                first: '<i class="bi bi-chevron-bar-left"></i>',
                previous: '<i class="bi bi-chevron-left"></i>',
                next: '<i class="bi bi-chevron-right"></i>',
                last: '<i class="bi bi-chevron-bar-right"></i>'
            }
        },
        drawCallback: function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
    });
    
    function showToast(message, type = 'primary') {
        Swal.fire({
            toast: true,
            position: 'bottom-end',
            icon: type === 'danger' ? 'error' : type,
            title: message,
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });
    }
});
</script>
{% endblock %}
